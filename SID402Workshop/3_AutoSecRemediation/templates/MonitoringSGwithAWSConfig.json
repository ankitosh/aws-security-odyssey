{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Resources":{
      "AwsConfigLambdaEc2SecuritygroupRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"awsconfig_lambda_ec2_security_group_role_policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:*:*:*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "config:PutEvaluations",
                "ec2:DescribeSecurityGroups",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:RevokeSecurityGroupIngress"
            ],
            "Resource": "*"
        },
                        {
                           "Action":[
                              "ec2:RunInstances"
                           ],
                           "Effect":"Deny",
                           "Resource":"arn:aws:ec2:*:*:instance/*",
                           "Condition":{
                              "StringNotEquals":{
                                 "ec2:InstanceType":[
                                    "t2.micro"
                                 ]
                              }
                           }
                        },
                        {
                           "Action":[
                              "ec2:*Spot*"
                           ],
                           "Effect":"Deny",
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "AwsConfigRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "config.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
    "PolicyName": "S3Access",
    "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject*"
            ],
            "Resource": [
                "arn:aws:s3:::*/AWSLogs/*/*"
            ],
            "Condition": {
                "StringLike": {
                    "s3:x-amz-acl": "bucket-owner-full-control"
                }
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetBucketAcl"
            ],
            "Resource": "arn:aws:s3:::*"
        }
    ]
}
               }
            ]
         }
      }
   }
}
